<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jantar Encantado - Reserva com Convites e Localiza√ß√£o</title>
    <!-- Incluindo Tailwind CSS para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Incluindo Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Incluindo html2canvas para captura de tela -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fundo escuro */
            color: #e5e7eb;
        }
        .card {
            background-color: #161b22; /* Card mais escuro */
            box-shadow: 0 4px 6px rgba(0, 250, 154, 0.1), 0 1px 3px rgba(0, 250, 154, 0.08);
        }
        .header-title {
            color: #00ff88; /* Verde esmeralda para destaque */
        }
        .input-style {
            background-color: #21262d;
            border: 1px solid #30363d;
            color: #e5e7eb;
        }
        .btn-primary {
            background-color: #00ff88;
            color: #161b22;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #00cc66;
        }
        .radio-card {
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            border: 2px solid transparent;
            background-color: #21262d; /* Fundo de card de r√°dio */
        }
        .radio-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 250, 154, 0.2);
        }
        /* Estilo para quando o r√°dio est√° CHECADO */
        input[type="radio"]:checked + label .radio-card {
            border-color: #00ff88;
            background-color: #00ff881a; /* Fundo levemente verde */
            box-shadow: 0 0 15px rgba(0, 250, 154, 0.4);
        }
        /* Estilo de erro para destacar grupos n√£o preenchidos */
        .validation-error {
            /* IMPORTANTE: Destaque visual forte e anima√ß√£o para garantir que o usu√°rio perceba */
            border: 2px solid #ff4d4d !important; /* Vermelho mais forte */
            background-color: #ff4d4d1a !important; /* Fundo vermelho leve */
            border-radius: 0.75rem; /* Um pouco mais arredondado */
            padding: 0.75rem; /* Um pouco mais de padding */
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        /* Estilo para o box de convite na tela final */
        .invite-box {
            background: linear-gradient(145deg, #1c232c, #0d1117);
            border: 2px solid #00ff88;
            box-shadow: 0 0 20px rgba(0, 250, 154, 0.5);
        }
        /* Bot√£o secund√°rio para copiar */
        .btn-secondary {
            background-color: #30363d;
            color: #e5e7eb;
            transition: background-color 0.3s;
            border: 1px solid #00ff88;
        }
        .btn-secondary:hover {
            background-color: #444c56;
        }
        /* Bot√£o de download */
        .btn-download {
            background-color: #00b894;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-download:hover {
            background-color: #00a085;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
        }

        /* Estilos espec√≠ficos para impress√£o: esconde elementos desnecess√°rios */
        @media print {
            body {
                background-color: #fff;
                color: #000;
            }
            .card {
                box-shadow: none !important;
                border: none !important;
                background-color: #fff !important;
            }
            .btn-primary, .btn-secondary {
                display: none; /* Esconde os bot√µes de a√ß√£o */
            }
            /* Garante que o conte√∫do seja vis√≠vel na impress√£o */
            .header-title, .text-white, .text-[#00ff88], .text-gray-400 {
                color: #000 !important;
            }
            .bg-gray-800, .bg-[#161b22] {
                background-color: #f0f0f0 !important; /* Fundo claro para se√ß√µes */
                color: #000 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }
        
        /* Estilo para o modal de captura */
        .capture-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .capture-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .capture-preview {
            max-width: 90%;
            max-height: 90%;
            border: 3px solid #00ff88;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 250, 154, 0.5);
        }
        
        .capture-loading {
            color: #00ff88;
            font-size: 1.2rem;
            text-align: center;
            padding: 20px;
        }
        
        .capture-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Estilos para a nova etapa de pacote */
        .package-card {
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .package-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 250, 154, 0.2);
        }
        
        .package-card.selected {
            border-color: #00ff88;
            background: linear-gradient(145deg, #00ff8810, #00ff8805);
            box-shadow: 0 0 20px rgba(0, 250, 154, 0.3);
        }
        
        .package-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .badge-premium {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        .badge-promo {
            background: linear-gradient(45deg, #FF4444, #FF6B6B);
            color: white;
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            position: absolute;
            top: 10px;
            right: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .price-old {
            text-decoration: line-through;
            color: #888;
            font-size: 1.2rem;
        }
        
        .price-new {
            color: #00ff88;
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        .discount-badge {
            background-color: #ff4444;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        
        .benefit-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .benefit-icon {
            color: #00ff88;
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .ribbon {
            position: absolute;
            top: 15px;
            left: -35px;
            background: linear-gradient(45deg, #FF4444, #FF6B6B);
            color: white;
            padding: 5px 40px;
            transform: rotate(-45deg);
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .featured-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            font-weight: bold;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 1rem;
            margin-bottom: 20px;
            display: inline-block;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }
            to { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        }
        
        .countdown-timer {
            background: linear-gradient(45deg, #1c232c, #0d1117);
            border: 2px solid #ff4444;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            margin-top: 20px;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
        }
        
        .countdown-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ff4444;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }
        
        .countdown-label {
            font-size: 0.8rem;
            color: #aaa;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-start justify-center">

    <div id="app-container" class="w-full max-w-4xl p-6 md:p-10 rounded-xl card my-8">
        
        <!-- √Årea de Mensagens de Status GLOBAL (Login e Feedback de C√≥pia) -->
        <div id="message-area" class="mb-4 hidden">
            <div id="status-message" class="p-3 rounded-lg text-center font-semibold"></div>
        </div>

        <!-- Onde o conte√∫do de cada etapa ser√° renderizado -->
        <div id="content">
            <h1 class="text-3xl font-bold header-title text-center mb-6">Carregando Jantar Encantado...</h1>
            <div class="flex justify-center items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-00ff88"></div>
            </div>
        </div>

    </div>

    <!-- Modal para visualizar captura de tela -->
    <div id="capture-modal" class="capture-modal">
        <button id="close-capture" class="capture-close">&times;</button>
        <div id="capture-loading" class="capture-loading hidden">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mx-auto mb-4"></div>
            Gerando captura de tela...
        </div>
        <img id="capture-preview" class="capture-preview hidden" alt="Pr√©-visualiza√ß√£o da captura">
    </div>

    <!-- Supabase Logic -->
    <script type="module">
        // üö® CONFIGURA√á√ÉO SUPABASE: SUBSTITUA COM SEUS DADOS REAIS üö®
        const SUPABASE_URL = 'https://yyayufgoboagvifxanfc.supabase.co'; 
		const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5YXl1ZmdvYm9hZ3ZpZnhhbmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MzMzNzksImV4cCI6MjA4MDEwOTM3OX0.fjREIYRCBIVCYNsKFzag2DXi96cavDbRzxblTTUFVDA'; 


        // Vari√°veis globais da aplica√ß√£o
        let supabaseClient = null;
        let userId = null; 
        let codigoUsado = null; 
        let convidadoPorNome = null; // Nome de quem convidou (dono do cupom - campo 'convite_de')
        let novoCodigoConvite = null; // C√≥digo gerado pelo cliente
        let reservationData = {}; 
        let currentStep = 'loading'; 
        let selectedPackage = 'promocional'; // Valor padr√£o

        // --- Inicializa√ß√£o e Configura√ß√£o ---

        function initializeApp() {
            console.log("1. initializeApp() - Iniciado.");

            // 0. VERIFICA√á√ÉO DE CONFIGURA√á√ÉO CR√çTICA
            if (SUPABASE_URL === 'SUA_URL_DO_SUPABASE' || SUPABASE_ANON_KEY === 'SUA_ANON_KEY_DO_SUPABASE') {
                console.error("2. ERRO: Chaves do Supabase n√£o configuradas. Mudando para 'error_config'.");
                currentStep = 'error_config';
                showMessage("ERRO DE CONFIGURA√á√ÉO: Por favor, configure as chaves do Supabase no c√≥digo.", true, true);
                render();
                return;
            }

            // 1. Inicializa o cliente Supabase
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("2. Supabase Client - Inicializado com sucesso.");
            } catch (e) {
                console.error("3. ERRO CR√çTICO ao criar o cliente Supabase:", e);
                currentStep = 'error_config';
                showMessage("Erro ao conectar com Supabase. Verifique as credenciais no Console (F12).", true, true);
                render();
                return;
            }

            // 2. Gera um ID de sess√£o √∫nico
            userId = crypto.randomUUID();
            console.log(`3. User ID - Gerado: ${userId}`);

            // 3. Move para a primeira etapa do aplicativo (Login de C√≥digo)
            currentStep = 'login';
            console.log("4. Transi√ß√£o de Estado - Movendo para 'login'.");
            render();
        }

        // --- Fun√ß√µes de Utilit√°rio e UI ---

        /** Exibe uma mensagem de status na tela. Se isPermanent for true, a mensagem n√£o desaparece. */
        function showMessage(text, isError = false, isPermanent = false) {
            const messageArea = document.getElementById('message-area');
            const statusMessage = document.getElementById('status-message');
            
            statusMessage.textContent = String(text); 
            messageArea.classList.remove('hidden');
            
            if (isError) {
                statusMessage.classList.remove('bg-green-700', 'text-white');
                statusMessage.classList.add('bg-red-700', 'text-white');
            } else {
                statusMessage.classList.remove('bg-red-700', 'text-white');
                statusMessage.classList.add('bg-green-700', 'text-white');
            }
            
            if (!isPermanent) {
                const duration = isError ? 10000 : 5000;
                setTimeout(() => messageArea.classList.add('hidden'), duration);
            }
        }

        /** Renderiza a UI com base no estado atual da aplica√ß√£o. */
        function render() {
            const contentDiv = document.getElementById('content');
            let html = '';

            console.log(`RENDER: Estado atual -> ${currentStep}`);

            switch (currentStep) {
                case 'loading':
                    html = renderLoadingStep();
                    break;
                
                case 'login':
                    html = renderLoginStep();
                    break;
                
                case 'cadastro':
                    html = renderRegistrationStep();
                    break;
                
                case 'pacote':
                    html = renderPackageSelectionStep();
                    break;
                
                case 'menu':
                    html = renderMenuSelectionStep();
                    break;
                
                case 'success':
                    html = renderSuccessStep();
                    break;
                
                case 'error_config':
                    html = renderErrorConfig();
                    break;

                default:
                    html = `<h1 class="text-3xl font-bold header-title text-center mb-6 text-red-500">Erro de Estado Desconhecido: ${currentStep}</h1>`;
                    break;
            }

            contentDiv.innerHTML = html;

            // Anexa listeners de eventos ap√≥s a renderiza√ß√£o
            if (currentStep === 'login') {
                document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            } else if (currentStep === 'cadastro') {
                document.getElementById('cadastro-form')?.addEventListener('submit', handleRegistration);
            } else if (currentStep === 'pacote') {
                // Adiciona listener para o formul√°rio de pacote
                document.getElementById('pacote-form')?.addEventListener('submit', handlePackageSelection);
                // Marca automaticamente o pacote promocional
                setTimeout(() => {
                    const promoRadio = document.getElementById('pacote-promocional');
                    if (promoRadio) {
                        promoRadio.checked = true;
                        const promoCard = document.getElementById('pacote-promocional-card');
                        if (promoCard) {
                            promoCard.classList.add('selected');
                        }
                    }
                }, 100);
            } else if (currentStep === 'menu') {
                document.getElementById('menu-form')?.addEventListener('submit', handleMenuSelection);
                // Adiciona event listeners para os radios para limpar erros quando selecionados
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        const container = document.getElementById(`group-container-${this.name}`);
                        if (container) {
                            container.classList.remove('validation-error');
                        }
                    });
                });
            }
            // Rola para o topo na tela de sucesso
            else if (currentStep === 'success') {
                // Adiciona listener para o novo bot√£o de c√≥pia e captura
                document.getElementById('copy-details-btn')?.addEventListener('click', handleCopyAndCapture);
                
                // Adiciona listener para o bot√£o de fechar no modal
                document.getElementById('close-capture')?.addEventListener('click', closeCaptureModal);

                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    document.getElementById('app-container')?.focus({ preventScroll: true }); 
                }, 100);
            }
        }

        // --- Fun√ß√µes de Captura de Tela ---

        /** Captura a tela da aplica√ß√£o e faz o download autom√°tico */
        async function captureAndDownloadScreen() {
            try {
                // Mostra o modal de carregamento
                const captureModal = document.getElementById('capture-modal');
                const captureLoading = document.getElementById('capture-loading');
                const capturePreview = document.getElementById('capture-preview');
                
                captureModal.classList.add('active');
                captureLoading.classList.remove('hidden');
                capturePreview.classList.add('hidden');
                
                // Captura o container principal da aplica√ß√£o
                const appContainer = document.getElementById('app-container');
                
                // Usa html2canvas para capturar a tela
                const canvas = await html2canvas(appContainer, {
                    scale: 2, // Maior qualidade
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#161b22',
                    onclone: function(clonedDoc) {
                        // Ajusta estilos para a captura
                        const clonedContainer = clonedDoc.getElementById('app-container');
                        if (clonedContainer) {
                            clonedContainer.style.boxShadow = '0 4px 6px rgba(0, 250, 154, 0.2)';
                        }
                    }
                });
                
                // Converte canvas para imagem
                const imageData = canvas.toDataURL('image/png');
                
                // Mostra pr√©-visualiza√ß√£o
                capturePreview.src = imageData;
                captureLoading.classList.add('hidden');
                capturePreview.classList.remove('hidden');
                
                // Aguarda um momento para o usu√°rio ver a pr√©-visualiza√ß√£o
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Cria link para download
                const downloadLink = document.createElement('a');
                const fileName = `reserva-jantar-encantado-${new Date().toISOString().slice(0,10)}.png`;
                
                downloadLink.href = imageData;
                downloadLink.download = fileName;
                
                // Inicia o download
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                // Fecha o modal ap√≥s 1.5 segundos (tempo para o download iniciar)
                setTimeout(() => {
                    closeCaptureModal();
                    showMessage("Captura de tela baixada com sucesso!");
                }, 1500);
                
            } catch (error) {
                console.error('Erro ao capturar tela:', error);
                closeCaptureModal();
                showMessage('Erro ao capturar a tela. Tente novamente.', true);
            }
        }

        /** Fecha o modal de captura */
        function closeCaptureModal() {
            const captureModal = document.getElementById('capture-modal');
            const captureLoading = document.getElementById('capture-loading');
            const capturePreview = document.getElementById('capture-preview');
            
            captureModal.classList.remove('active');
            captureLoading.classList.add('hidden');
            capturePreview.classList.add('hidden');
        }

        // --- Fun√ß√µes de C√≥pia e Captura Combinadas ---

        /** Copia os detalhes da reserva e captura a tela */
        function handleCopyAndCapture() {
            // Primeiro, copia os detalhes da reserva
            copyReservationDetails();
            
            // Depois, ap√≥s um pequeno delay, captura a tela
            setTimeout(() => {
                captureAndDownloadScreen();
            }, 300);
        }

        /** Copia os detalhes da reserva para a √°rea de transfer√™ncia. */
        function copyReservationDetails() {
            // Monta o texto completo com o c√≥digo de convite
            const reservationText = `
--- DETALHES DA RESERVA JANTAR ENCANTADO ---
Nome: ${reservationData.nome}
Infus√£o: ${reservationData.infusao}
Convidado por: ${convidadoPorNome || reservationData.convidado_por || 'N/A'}
Pacote: ${selectedPackage === 'premium' ? 'Premium (R$ 289,90)' : 'Promocional (R$ 190,00)'}

Card√°pio Escolhido:
Aperitivo: ${reservationData.aperitivo}
Entrada: ${reservationData.entrada}
Prato Principal: ${reservationData.principal}
Sobremesa: ${reservationData.sobremesa}
Bebida: ${reservationData.bebida}

Local: CASA JARDIM : Rua S√£o Miguel, 42 - Santo Antonio, Vi√ßosa - MG
In√≠cio: 17:20h
---
SEU C√ìDIGO DE CONVITE: ${novoCodigoConvite || 'Falha ao Gerar C√≥digo'}
Envie este c√≥digo para um amigo!
`.trim();

            // Usa a forma moderna, mas com fallback para execCommand
            if (navigator.clipboard) {
                navigator.clipboard.writeText(reservationText).then(() => {
                    // Mensagem ser√° mostrada pela fun√ß√£o de captura de tela
                }).catch(err => {
                    console.error('Falha ao copiar (Clipboard API):', err);
                    fallbackCopyTextToClipboard(reservationText);
                });
            } else {
                fallbackCopyTextToClipboard(reservationText);
            }
        }
        
        /** Fallback para dispositivos mais antigos ou iFrames restritos */
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            // Torna o textarea invis√≠vel e fora da tela
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
            } catch (err) {
                console.error('Falha ao copiar (execCommand):', err);
            }
            document.body.removeChild(textArea);
        }

        // --- Renderiza√ß√£o de Etapas ---
        function renderLoadingStep() {
            return `
                <h1 class="text-3xl font-bold header-title text-center mb-6">Aguarde...</h1>
                <p class="text-center text-gray-400 mb-6">Tentando iniciar o aplicativo...</p>
                <div class="flex justify-center items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
                </div>
            `;
        }
        
        function renderErrorConfig() {
            return `
                <div class="text-center p-8 bg-red-900/20 rounded-xl border border-red-700/50">
                    <h1 class="text-3xl font-bold text-red-500 mb-4">ERRO CR√çTICO DE CONFIGURA√á√ÉO!</h1>
                    <p class="text-lg text-gray-300 mb-6">
                        A aplica√ß√£o n√£o conseguiu inicializar o Supabase.
                    </p>
                    <p class="text-red-400 font-bold mb-3">
                        Por favor, SUBSTITUA os valores placeholder no in√≠cio do script:
                    </p>
                    <pre class="bg-gray-800 p-4 rounded-lg mt-4 text-sm text-left overflow-x-auto border border-red-500">
const SUPABASE_URL = '<span class="text-yellow-400">SUA_URL_DO_SUPABASE</span>';
const SUPABASE_ANON_KEY = '<span class="text-yellow-400">SUA_ANON_KEY_DO_SUPABASE</span>';
                    </pre>
                    <p class="text-center mt-6 text-gray-500">
                        Ap√≥s corrigir os dados (URL e ANONYMOUS KEY), salve e recarregue a p√°gina.
                    </p>
                </div>
            `;
        }

        function renderLoginStep() {
            return `
                <h1 class="text-3xl font-bold header-title text-center mb-8">Bem-vindo(a) ao Jantar Encantado</h1>
                <p class="text-center mb-6 text-gray-400">Insira seu c√≥digo promocional para acessar a reserva.</p>
                <form id="login-form" class="max-w-md mx-auto">
                    <div class="mb-6">
                        <label for="codigo" class="block text-sm font-medium mb-2">C√≥digo de Acesso</label>
                        <input type="text" id="codigo" name="codigo" required 
                               class="w-full p-3 rounded-lg input-style focus:ring-2 focus:ring-[#00ff88]"
                               placeholder="Ex: PROMO-001">
                    </div>
                    <button type="submit" class="w-full btn-primary p-3 rounded-lg font-semibold uppercase">
                        Acessar
                    </button>
                    <div id="login-loading" class="hidden text-center mt-4">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-500 mx-auto"></div>
                    </div>
                </form>
            `;
        }

        function renderRegistrationStep() {
            // Exibe o nome do convidante se ele existir
            const convidadoHtml = convidadoPorNome ? 
                `<div class="p-3 bg-[#00ff881a] rounded-lg mb-6 border border-[#00ff88] text-[#00ff88]">
                    <p class="text-center font-semibold">Convidado por: ${convidadoPorNome}</p>
                 </div>` : '';

            return `
                <h1 class="text-3xl font-bold header-title text-center mb-8">Passo 1: Seus Dados</h1>
                ${convidadoHtml}
                <form id="cadastro-form" class="max-w-xl mx-auto space-y-4">
                    
                    <div>
                        <label for="nome" class="block text-sm font-medium mb-1">Nome Completo</label>
                        <input type="text" id="nome" name="nome" required 
                               class="w-full p-3 rounded-lg input-style focus:ring-2 focus:ring-[#00ff88]"
                               placeholder="Seu nome">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <!-- R√≥tulo alterado -->
                            <label for="telefone" class="block text-sm font-medium mb-1">Celular/Whatsapp</label>
                            <input type="tel" id="telefone" name="telefone" required 
                                   class="w-full p-3 rounded-lg input-style focus:ring-2 focus:ring-[#00ff88]"
                                   placeholder="(99) 99999-9999">
                        </div>
                        <div class="flex items-end pb-3">
                            <input type="checkbox" id="whatsapp" name="whatsapp" 
                                   class="h-5 w-5 rounded text-[#00ff88] focus:ring-[#00ff88] border-gray-600 bg-gray-700">
                            <!-- Texto do checkbox e l√≥gica invertida -->
                            <label for="whatsapp" class="ml-2 text-sm font-medium">marque aqui se este numero n√£o for whatsapp</label>
                        </div>
                    </div>

                    <!-- DATA DE NASCIMENTO: Tr√™s campos de entrada -->
                    <div>
                        <label class="block text-sm font-medium mb-1">Data de Nascimento (DD/MM/AAAA)</label>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="number" id="nascimento_dia" name="nascimento_dia" required min="1" max="31"
                                   class="w-full p-3 rounded-lg input-style focus:ring-2 focus:ring-[#00ff88] text-center"
                                   placeholder="Dia">
                            <input type="number" id="nascimento_mes" name="nascimento_mes" required min="1" max="12"
                                   class="w-full p-3 rounded-lg input-style focus:ring-2 focus:ring-[#00ff88] text-center"
                                   placeholder="M√™s">
                            <input type="number" id="nascimento_ano" name="nascimento_ano" required min="1900" max="2099"
                                   class="w-full p-3 rounded-lg input-style focus:ring-2 focus:ring-[#00ff88] text-center"
                                   placeholder="Ano">
                        </div>
                    </div>

                    <div class="pt-4">
                        <label class="block text-base font-medium mb-3 header-title">N√≠vel de Infus√£o Can√°bico</label>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            ${['Sem infus√£o', 'Infus√£o leve', 'Infus√£o m√©dia', 'Infus√£o madura'].map((option, index) => `
                                <div key="${index}">
                                    <input type="radio" id="infusao${index}" name="infusao" value="${option}" class="hidden" required>
                                    <label for="infusao${index}" class="block cursor-pointer">
                                        <div class="radio-card p-4 rounded-lg text-center text-base border-gray-700">
                                            ${option}
                                        </div>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="pt-6">
                        <button type="submit" class="w-full btn-primary p-3 rounded-lg font-semibold uppercase">
                            Continuar para Escolha do Pacote
                        </button>
                    </div>
                </form>
            `;
        }

        function renderPackageSelectionStep() {
            return `
                <h1 class="text-3xl font-bold header-title text-center mb-6">üéâ Escolha Seu Pacote de Experi√™ncia!</h1>
                <p class="text-center text-gray-400 mb-8 text-lg">Selecione a op√ß√£o perfeita para sua noite encantada</p>
                
                <!-- Badge em destaque -->
                <div class="text-center mb-8">
                    <div class="featured-badge">üî• PROMO√á√ÉO DE INAUGURA√á√ÉO EXCLUSIVA! üî•</div>
                </div>
                
                
                <form id="pacote-form" class="space-y-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Pacote Premium (Indispon√≠vel) -->
                        <div class="relative">
                            <div class="ribbon">INDISPON√çVEL</div>
                            <div id="pacote-premium-card" class="package-card disabled p-6 rounded-xl h-full flex flex-col">
                                <div class="flex-grow">
                                    <div class="badge-premium">PREMIUM</div>
									<p class="text-gray-400 mb-6"></br></p>
                                    <h3 class="text-2xl font-bold text-white mb-4">Experi√™ncia Completa</h3>
                                    <p class="text-gray-400 mb-6">Para quem busca o m√°ximo de sofistica√ß√£o e exclusividade</p>
                                    
                                    <div class="mb-6">
                                        <div class="price-new text-center mb-4">R$ 289,90</div>
                                        <p class="text-center text-gray-400 text-sm">(pre√ßo regular)</p>
                                    </div>
                                    
                                    <div class="space-y-4 mb-8">
                                        <div class="benefit-item">
                                            <span class="benefit-icon">‚úì</span>
                                            <span>Menu degusta√ß√£o completo 4 pratos</span>
                                        </div>
                                        <div class="benefit-item">
                                            <span class="benefit-icon">‚úì</span>
                                            <span>Sele√ß√£o individual de pratos</span>
                                        </div>
                                        <div class="benefit-item">
                                            <span class="benefit-icon">‚úì</span>
                                            <span>Op√ßoes veganas</span>
                                        </div>
                                        <div class="benefit-item">
                                            <span class="benefit-icon">‚úì</span>
                                            <span>Experi√™ncia sensorial inigual√°vel</span>
                                        </div>
                                        <div class="benefit-item">
                                            <span class="benefit-icon">‚úì</span>
                                            <span>Atendimento VIP personalizado</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-auto">
                                    <div class="text-center mb-4">
                                        <span class="text-red-400 font-bold">üîí Temporariamente Indispon√≠vel</span>
                                    </div>
                                    <label class="block cursor-not-allowed">
                                        <input type="radio" id="pacote-premium" name="pacote" value="premium" class="hidden" disabled>
                                        <div class="w-full p-4 rounded-lg text-center bg-gray-900 text-gray-500 font-semibold">
                                            SELECIONAR PACOTE PREMIUM
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pacote Promocional (Selecionado por padr√£o) -->
                        <div class="relative">
                            <div id="pacote-promocional-card" class="package-card selected p-6 rounded-xl h-full flex flex-col border-2 border-[#ff4444]">
                                <div class="flex-grow">
                                    <div class="badge-promo">üî• PROMO√á√ÉO!</div>
									<p class="text-gray-400 mb-6"></br></p>
                                    <h3 class="text-2xl font-bold text-white mb-4">Jantar Encantado VIP</h3>
                                    <p class="text-gray-400 mb-6">Oferta especial de inaugura√ß√£o - Experi√™ncia completa por um pre√ßo irresist√≠vel!</p>
                                    
                                    <div class="mb-6">
                                        <div class="price-old text-center mb-2">De: R$ 289,90</div>
                                        <div class="price-new text-center mb-2">Por apenas: R$ 190,00</div>
                                        <div class="text-center">
                                            <span class="discount-badge">34% DE DESCONTO</span>
                                        </div>
                                        <p class="text-center text-gray-400 text-sm mt-2">Economize R$ 99,90!</p>
                                    </div>
                                    
                                    <div class="space-y-4 mb-8">
                                        <div class="benefit-item">
                                            <span class="benefit-icon">üéÅ</span>
                                            <span><strong>Menu degusta√ß√£o completo 4 pratos</strong></span>
                                        </div>
                                        <div class="benefit-item">
                                            <span class="benefit-icon">üéÅ</span>
                                            <span><strong>Sele√ß√£o individual de pratos</strong></span>
                                        </div>
                                        <div class="benefit-item">
                                            <span class="benefit-icon">üéÅ</span>
                                            <span><strong>Experi√™ncia Sensorial inigual√°vel</strong></span>
                                        </div>
                                        <div class="benefit-item">
                                            <span class="benefit-icon">üéÅ</span>
                                            <span><strong>Op√ß√µes de pratos veganos</strong></span>
                                        </div>
                                        <div class="benefit-item">
                                            <span class="benefit-icon">üéÅ</span>
                                            <span><strong>Ambiente exclusivo e intimista</strong></span>
                                        </div>
                                        <div class="benefit-item">
                                            <span class="benefit-icon">‚ö°</span>
                                            <span><strong>B√îNUS:</strong>Ganhe 1 c√≥digo de convite personalizado e gere desconto em sua reserva!</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-auto">
                                    <div class="text-center mb-4">
                                        <span class="text-[#00ff88] font-bold text-lg">‚≠ê RECOMENDADO PELA EQUIPE ‚≠ê</span>
                                    </div>
                                    <label class="block cursor-pointer">
                                        <input type="radio" id="pacote-promocional" name="pacote" value="promocional" class="hidden" checked>
                                        <div class="w-full p-4 rounded-lg text-center bg-gradient-to-r from-[#ff4444] to-[#ff6b6b] text-white font-bold text-lg hover:from-[#ff3333] hover:to-[#ff5555] transition-all duration-300 shadow-lg hover:shadow-xl">
                                            üéØ SELECIONAR PACOTE PROMOCIONAL
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot√£o de continuar -->
                    <div class="pt-6">
                        <button type="submit" class="w-full btn-primary p-4 rounded-lg font-bold text-xl uppercase tracking-wider shadow-lg hover:shadow-xl transition-all duration-300">
                            üçΩÔ∏è AVAN√áAR PARA SELE√á√ÉO DO MENU
                        </button>
                        <p class="text-center text-gray-400 mt-4 text-sm">
                            ‚ö° <strong>Oferta v√°lida apenas para reservas realizadas hoje!</strong>
                        </p>
                    </div>
                </form>
            `;
        }

        function renderMenuSelectionStep() {
            const menuItems = {
                aperitivo: { title: 'Aperitivo', options: ['1. Coxinha de Jaca', '2. Bruschetta'] },
                entrada: { title: 'Entrada', options: ['1. Creme de ab√≥bora', '2. Salada Caesar/Caprese'] },
                principal: { title: 'Prato Principal', options: ['1. Nhoc ao molho pesto acompanhado de tiras de carne', '2. Risoto de tomate acompanhado de tiras de carne'] },
                sobremesa: { title: 'Sobremesa', options: ['1. Iogurte assado com compota de frutas', '2. Iogurte assado com compota de frutas (vegano)'] },
                bebida: { title: 'Bebida', options: ['1. Ch√° de Hibisco', '2. Suco de manga'] },
            };

            return `
                <h1 class="text-3xl font-bold header-title text-center mb-4">Passo 3: Personalize Seu Menu</h1>
                <p class="text-center text-gray-400 mb-8">Escolha suas op√ß√µes preferidas para cada prato do seu <strong>Pacote ${selectedPackage === 'premium' ? 'Premium' : 'Promocional'}</strong></p>
                
                <!-- Resumo do pacote selecionado -->
                <div class="mb-8 p-6 rounded-lg bg-gradient-to-r from-[#00ff8810] to-[#00ff8805] border-l-4 border-[#00ff88]">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">Pacote Selecionado: <span class="text-[#00ff88]">${selectedPackage === 'premium' ? 'Experi√™ncia Premium' : 'Jantar Encantado VIP'}</span></h2>
                            <p class="text-sm text-gray-400">${selectedPackage === 'premium' ? 'R$ 289,90' : 'R$ 190,00 (Promo√ß√£o de Inaugura√ß√£o!)'}</p>
                        </div>
                        <div class="mt-4 md:mt-0">
                            <span class="px-4 py-2 rounded-full ${selectedPackage === 'premium' ? 'bg-gradient-to-r from-yellow-600 to-yellow-800' : 'bg-gradient-to-r from-red-600 to-red-800'} text-white font-bold">
                                ${selectedPackage === 'premium' ? 'PREMIUM' : '34% OFF'}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes do Jantar -->
                <div class="mb-8 p-6 rounded-lg bg-gray-800 border-l-4 border-[#00ff88]">
                    <h2 class="text-2xl font-bold mb-3">üìÖ Agenda do Jantar Encantado</h2>
                    <p class="text-sm text-gray-400 mb-4">S√°bado, 13 de dezembro.</p>
                    <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 text-sm">
                        <div><strong class="text-[#00ff88]">17:20:</strong> In√≠cio</div>
                        <div><strong class="text-[#00ff88]">18:30:</strong> Aperitivo</div>
                        <div><strong class="text-[#00ff88]">19:30:</strong> Entrada</div>
						<div><strong class="text-[#00ff88]">20:40:</strong> Principal</div>
                        <div><strong class="text-[#00ff88]">22:00:</strong> Sobremesa</div>
                        <div><strong class="text-[#00ff88]">23:00:</strong> Encerramento</div>
                    </div>
                    <p class="mt-4 text-xs text-gray-500">Intervalos de 10 a 20 minutos entre os pratos para socializa√ß√£o.</p>
                </div>

                <form id="menu-form" class="space-y-8">
                    <!-- Nova caixa de erro ESPEC√çFICA para o Menu - Exibi√ß√£o no topo -->
                    <div id="menu-error-message" class="hidden p-4 rounded-lg text-center font-semibold bg-red-700 text-white mb-6">
                        <!-- Mensagem de erro ser√° inserida aqui pelo JS -->
                    </div>

                    ${Object.keys(menuItems).map(key => {
                        const item = menuItems[key];
                        return `
                            <!-- Adicionei padding extra e margem para o efeito de erro ser claro -->
                            <div id="group-container-${key}" class="pt-6 border border-transparent transition-all duration-300">
                                <h3 class="text-xl font-semibold mb-4 text-[#00ff88] uppercase tracking-wider">${item.title}</h3>
                                <div id="group-${key}" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${item.options.map((option, index) => `
                                        <div>
                                            <input type="radio" id="${key}${index}" name="${key}" value="${option}" class="hidden" required>
                                            <label for="${key}${index}" class="block cursor-pointer">
                                                <div class="radio-card p-4 rounded-lg text-base border-gray-700">
                                                    ${option}
                                                </div>
                                            </label>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
					<p class="text-center text-gray-400 mb-8">** Selecione todas as op√ß√µes para personalizar sua experi√™ncia</p>
                    <div class="pt-6">
                        <button type="submit" class="w-full btn-primary p-4 rounded-lg font-bold text-xl uppercase tracking-wider shadow-lg hover:shadow-xl transition-all duration-300">
                            ‚ú® FINALIZAR RESERVA
                        </button>
                        <div id="menu-loading" class="hidden text-center mt-4">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-500 mx-auto"></div>
                        </div>
                    </div>
                </form>
            `;
        }

        function renderSuccessStep() {
            // O nome do convidante agora √© pego da vari√°vel global ou do objeto de reserva (que foi atualizado em handleMenuSelection apenas para exibi√ß√£o)
            const displayConvidadoPor = convidadoPorNome || reservationData.convidado_por || 'N/A';
            const pacoteNome = selectedPackage === 'premium' ? 'Experi√™ncia Premium (R$ 289,90)' : 'Jantar Encantado VIP (R$ 190,00)';
            const pacoteEconomia = selectedPackage === 'premium' ? '' : '<p class="text-sm text-green-400 mt-1">üéâ Voc√™ economizou R$ 99,90 com a promo√ß√£o de inaugura√ß√£o!</p>';

            return `
                <div class="text-center p-8">
                    <svg class="mx-auto h-16 w-16 text-[#00ff88]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h1 class="text-3xl font-bold header-title mt-4 mb-3">üéä Reserva Confirmada com Sucesso!</h1>
                    <p class="text-lg text-gray-400 mb-6">Sua experi√™ncia encantada est√° garantida!</p>

                    <!-- Detalhes da Reserva e C√≥digo -->
                    <div class="text-left max-w-sm mx-auto p-6 bg-gray-800 rounded-xl mb-6 shadow-lg">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-[#00ff88]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Seus Detalhes
                        </h2>
                        <div class="space-y-3">
                            <p class="text-sm"><strong class="text-[#00ff88]">Nome:</strong> ${reservationData.nome}</p>
                            <p class="text-sm"><strong class="text-[#00ff88]">Infus√£o:</strong> ${reservationData.infusao}</p>
                            <p class="text-sm"><strong class="text-[#00ff88]">Pacote:</strong> ${pacoteNome}</p>
                            ${pacoteEconomia}
                            <p class="text-sm"><strong class="text-[#00ff88]">ID da Reserva:</strong> <code class="break-all text-xs text-yellow-400 bg-gray-900 p-1 rounded">${reservationData.session_id || 'N/A'}</code></p>
                            <p class="text-sm"><strong class="text-[#00ff88]">Convidado por:</strong> ${displayConvidadoPor}</p>
                        </div>
                    </div>

                    <!-- Bot√£o de SALVAR DETALHES (Agora com captura de tela autom√°tica) -->
                    <button id="copy-details-btn" class="w-full max-w-sm mx-auto btn-download p-4 rounded-lg font-bold text-lg uppercase mt-6 flex items-center justify-center space-x-3 shadow-lg hover:shadow-xl transition-all duration-300">
                        <!-- Icone de C√¢mera e Disqueto SVG -->
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v10m4-10v10m4-10v10M3 19h18a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <span>Salvar Detalhes da Reserva</span>
                    </button>

                    <!-- BOX DE CONVITE -->
                    <div class="text-center max-w-sm mx-auto p-6 rounded-xl mt-8 mb-8 invite-box shadow-2xl">
                        <h3 class="text-2xl font-extrabold text-[#00ff88] uppercase tracking-wider mb-3">üéÅ Convide um Amigo e Ganhe!</h3>
                        <p class="text-sm text-gray-300 italic mb-4">*Compartilhe seu c√≥digo de convite e ambos ganham 15% de desconto na pr√≥xima reserva!</p>
                        <div class="bg-gray-900 p-4 rounded-lg border-2 border-dashed border-gray-700">
                            <p class="text-sm text-gray-400 mb-2">SEU C√ìDIGO EXCLUSIVO:</p>
                            <strong class="text-3xl text-white font-mono tracking-wider">${novoCodigoConvite || 'Falha ao Gerar C√≥digo'}</strong>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">Mostre este c√≥digo na entrada do evento</p>
                    </div>

                    <!-- Card√°pio Selecionado -->
                    <div class="text-left max-w-sm mx-auto p-6 bg-gray-800 rounded-xl mb-8 shadow-lg">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-[#00ff88]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                            </svg>
                            Card√°pio Personalizado
                        </h2>
                        <ul class="list-none pl-0 space-y-3 text-sm">
                            <li class="p-3 rounded-md bg-[#161b22]"><strong class="text-[#00ff88]">Aperitivo:</strong> ${reservationData.aperitivo}</li>
                            <li class="p-3 rounded-md bg-[#161b22]"><strong class="text-[#00ff88]">Entrada:</strong> ${reservationData.entrada}</li>
                            <li class="p-3 rounded-md bg-[#161b22]"><strong class="text-[#00ff88]">Prato Principal:</strong> ${reservationData.principal}</li>
                            <li class="p-3 rounded-md bg-[#161b22]"><strong class="text-[#00ff88]">Sobremesa:</strong> ${reservationData.sobremesa}</li>
                            <!-- Bebida -->
                            <li class="p-3 rounded-md bg-[#161b22]"><strong class="text-[#00ff88]">Bebida:</strong> ${reservationData.bebida}</li>
                        </ul>
                    </div>

                    <!-- Localiza√ß√£o e Mapa -->
                    <div class="text-left max-w-xl mx-auto p-6 bg-gray-800 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-[#00ff88]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Local e Hor√°rio
                        </h2>
                        <div class="space-y-3 mb-6">
                            <p class="text-sm"><strong class="text-[#00ff88]">‚è∞ In√≠cio do Jantar:</strong> 17:20h</p>
                            <p class="text-sm"><strong class="text-[#00ff88]">üìç Endere√ßo:</strong> CASA JARDIM : Rua S√£o Miguel, 42 - Santo Antonio, Vi√ßosa - MG</p>
                            <p class="text-xs text-gray-500">Recomendamos chegar com 15 minutos de anteced√™ncia</p>
                        </div>
                        
                        <div class="w-full rounded-lg overflow-hidden border-2 border-[#00ff88] shadow-lg">
                            <!-- Placeholder do Google Maps -->
                            <iframe src="https://www.google.com/maps/embed?pb=!1m10!1m8!1m3!1d466.3867758726789!2d-42.8654175!3d-20.7469754!3m2!1i1024!2i768!4f13.1!5e0!3m2!1spt-BR!2sbr!4v1764698559557!5m2!1spt-BR!2sbr" width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                        </div>
                    </div>

                    <!-- Bot√£o de Impress√£o/Salvar PDF -->
                    <button onclick="window.print()" class="w-full max-w-xl mx-auto btn-primary p-4 rounded-lg font-bold text-lg uppercase mt-10 flex items-center justify-center space-x-3 shadow-lg hover:shadow-xl transition-all duration-300">
                        <!-- Icone de Impressora SVG -->
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0v-4m0 4h2m-2 0h-2m-2 0h-2m2 0H7m0-4V9a2 2 0 012-2h6a2 2 0 012 2v4m-2 0H9m-2 0h-2"></path>
                        </svg>
                        <span>üìÑ Imprimir / Salvar PDF da Reserva</span>
                    </button>

                    <p class="mt-10 text-lg text-gray-300 font-bold">‚ú® Aguardamos voc√™ para uma noite verdadeiramente encantada! ‚ú®</p>
                    <p class="mt-2 text-sm text-gray-500">Em caso de d√∫vidas, entre em contato pelo WhatsApp informado na reserva.</p>
                </div>
            `;
        }

        // --- L√≥gica de A√ß√£o (Login/Cadastro/Pacote/Menu) ---

        /** Processo de login verificando se o c√≥digo existe na tabela 'login' do Supabase. */
        async function handleLogin(event) {
            event.preventDefault();
            const form = event.target;
            const codigo = form.codigo.value.trim().toLowerCase();
            const loadingIndicator = document.getElementById('login-loading');

            if (!codigo) {
                showMessage("Por favor, insira o c√≥digo de acesso.", true);
                return;
            }

            loadingIndicator.classList.remove('hidden');

            try {
                // 1. Consulta a tabela 'login'
                const { data, error } = await supabaseClient
                    .from('login')
                    // Seleciona o 'convite_de' para saber quem convidou
                    .select('codigo, convite_de') 
                    .eq('codigo', codigo)
                    .single(); 

                // Tratamento de erro robusto, especialmente para o erro de 'registro n√£o encontrado' (PGRST116)
                if (error && error.code !== 'PGRST116') { 
                    showMessage(`Erro Supabase ao consultar c√≥digo: ${error.message || 'Falha desconhecida.'} (Verifique o RLS)`, true);
                    return; 
                }

                if (data && data.codigo) {
                    // C√ìDIGO V√ÅLIDO: Armazena o c√≥digo e o nome do convidante
                    codigoUsado = codigo;
                    convidadoPorNome = data.convite_de || 'Convidante Misterioso'; // <-- Nome do convidante setado globalmente
                    
                    showMessage("C√≥digo v√°lido! Voc√™ tem um convite exclusivo.");
                    currentStep = 'cadastro';
                    render();
                } else {
                    // C√ìDIGO INV√ÅLIDO ou n√£o encontrado
                    showMessage("C√≥digo de acesso inv√°lido. Tente novamente.", true);
                }

            } catch (error) {
                showMessage(`Erro Geral durante o Login: ${error.message || 'Falha desconhecida.'}`, true);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        /** Lida com o cadastro inicial do usu√°rio e armazena os dados temporariamente. */
        function handleRegistration(event) {
            event.preventDefault();
            const form = event.target;
            
            const nome = form.nome.value.trim();
            const telefone = form.telefone.value.trim();
            
            // Novos campos de data
            const dia = form.nascimento_dia.value.trim();
            const mes = form.nascimento_mes.value.trim();
            const ano = form.nascimento_ano.value.trim();

            const infusaoInput = form.infusao;
            let infusao = null;
            
            // L√ìGICA INVERTIDA AQUI: Se o checkbox est√° marcado, N√ÉO √© WhatsApp.
            const isNotWhatsApp = form.whatsapp.checked;
            const whatsapp = isNotWhatsApp ? 'N√£o' : 'Sim'; 

            if (infusaoInput instanceof RadioNodeList) {
                infusao = infusaoInput.value;
            } else if (infusaoInput) {
                infusao = infusaoInput.value;
            }

            // CR√çTICO: Valida√ß√£o de todos os campos
            if (!nome || !telefone || !dia || !mes || !ano || !infusao) {
                 showMessage("Por favor, preencha todos os campos do cadastro (Nome, Telefone, Data de Nascimento completa e N√≠vel de Infus√£o).", true);
                 return;
            }
            
            // Formata√ß√£o da data (DD/MM/AAAA)
            // Garante que dia e m√™s tenham 2 d√≠gitos (ex: 5 -> 05)
            const formattedNascimento = `${dia.padStart(2, '0')}/${mes.padStart(2, '0')}/${ano}`;


            // Armazena no objeto de reserva
            reservationData = {
                session_id: userId, // Garante que o ID da sess√£o esteja no objeto
                nome,
                telefone,
                whatsapp, // Agora armazena 'Sim' ou 'N√£o' com a nova l√≥gica
                nascimento: formattedNascimento, // Data formatada
                infusao,
                created_at: new Date().toISOString()
            };

            currentStep = 'pacote';
            render();
        }

        /** Lida com a sele√ß√£o do pacote */
        function handlePackageSelection(event) {
            event.preventDefault();
            const form = event.target;
            
            // Obt√©m o pacote selecionado
            const selectedPacote = form.pacote.value;
            selectedPackage = selectedPacote;
            
            // Salva a informa√ß√£o do pacote nos dados da reserva
            reservationData.pacote = selectedPacote;
            reservationData.valor_pacote = selectedPacote === 'premium' ? '289.90' : '190.00';
            
            showMessage(`Pacote ${selectedPacote === 'premium' ? 'Premium' : 'Promocional'} selecionado com sucesso!`);
            currentStep = 'menu';
            render();
        }

        /** Gera um novo c√≥digo de convite baseado no nome do cliente. */
        function generateNewInviteCode(fullName) {
            // Remove acentos, caracteres especiais e normaliza para min√∫sculas.
            const normalizedName = fullName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            const parts = normalizedName.split(/\s+/).filter(p => p.length > 0);
            
            if (parts.length < 2) {
                return `${parts[0] || 'convite'}420`;
            }
            
            // Combina o primeiro nome com o √∫ltimo sobrenome
            const firstName = parts[0];
            const lastName = parts[parts.length - 1]; 
            
            return `${firstName}${lastName}420`;
        }


        /** Combina os dados de cadastro e menu, salva na tabela 'clientes' e gera novo c√≥digo de convite. */
        async function handleMenuSelection(event) {
            event.preventDefault();
            console.log("Iniciando valida√ß√£o do Menu...");
            const form = event.target;
            const loadingIndicator = document.getElementById('menu-loading');
            
            // 1. VALIDA√á√ÉO DO MENU - VERIFICA√á√ÉO SIMPLIFICADA E EFETIVA
            const menuItems = ['aperitivo', 'entrada', 'principal', 'sobremesa', 'bebida'];
            let isValid = true;
            let missingItems = [];
            
            // Remove classes de erro anteriores
            menuItems.forEach(key => {
                const container = document.getElementById(`group-container-${key}`);
                if (container) {
                    container.classList.remove('validation-error');
                }
            });
            
            // Verifica cada item do menu
            menuItems.forEach(key => {
                const selectedRadio = form.querySelector(`input[name="${key}"]:checked`);
                if (!selectedRadio) {
                    isValid = false;
                    missingItems.push(key);
                    // Aplica estilo de erro ao container
                    const container = document.getElementById(`group-container-${key}`);
                    if (container) {
                        container.classList.add('validation-error');
                    }
                }
            });
            
            // Se n√£o for v√°lido, mostra erro e para a execu√ß√£o
            if (!isValid) {
                console.log("Menu n√£o preenchido completamente. Itens faltantes:", missingItems);
                
                // Cria uma mensagem de erro amig√°vel
                const itemNames = {
                    'aperitivo': 'Aperitivo',
                    'entrada': 'Entrada',
                    'principal': 'Prato Principal',
                    'sobremesa': 'Sobremesa',
                    'bebida': 'Bebida'
                };
                
                const missingNames = missingItems.map(item => itemNames[item]).join(', ');
                const errorMessage = `Por favor, selecione uma op√ß√£o para: ${missingNames}`;
                
                // Usa a fun√ß√£o showMessage para exibir o erro
                showMessage(errorMessage, true);
                
                // Rola para o primeiro item com erro
                const firstErrorContainer = document.getElementById(`group-container-${missingItems[0]}`);
                if (firstErrorContainer) {
                    firstErrorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return; // Impede a execu√ß√£o do restante da fun√ß√£o
            }
            
            console.log("Valida√ß√£o do menu conclu√≠da com sucesso. Processando reserva...");
            
            // Se chegou aqui, todos os campos est√£o preenchidos
            loadingIndicator.classList.remove('hidden');
            
            try {
                // 2. Coleta os dados do menu
                const menuSelection = {};
                menuItems.forEach(key => {
                    const selectedRadio = form.querySelector(`input[name="${key}"]:checked`);
                    if (selectedRadio) {
                        menuSelection[key] = selectedRadio.value;
                    }
                });
                
                // 3. Tenta Gerar e Inserir o Novo C√≥digo de Convite
                const newCode = generateNewInviteCode(reservationData.nome);
                novoCodigoConvite = newCode; 

                const { error: loginError } = await supabaseClient
                    .from('login')
                    .insert([
                        { 
                            codigo: newCode, 
                            convite_de: reservationData.nome
                        }
                    ]);

                if (loginError) {
                    console.error("Falha na gera√ß√£o do c√≥digo de convite:", loginError.message);
                    showMessage(`Aviso: Falha ao gerar o c√≥digo de convite. Causa: ${loginError.message}. A reserva continuar√°.`, true);
                    novoCodigoConvite = "Falha ao Gerar - Verifique RLS";
                }

                // 4. Combina os dados e insere na tabela 'clientes'
                const finalDataForDB = { 
                    ...reservationData, 
                    ...menuSelection, 
                    codigo_usado: codigoUsado,
                };
                
                const { error: clientesError } = await supabaseClient
                    .from('clientes')
                    .insert([finalDataForDB]);
                
                if (clientesError) {
                    console.error("ERRO CR√çTICO ao salvar na tabela 'clientes':", clientesError.message);
                    showMessage(`ERRO CR√çTICO: N√£o foi poss√≠vel salvar sua reserva. Causa: ${clientesError.message || 'Falha desconhecida.'} (VERIFIQUE RLS/SCHEMA DA TABELA CLIENTES)`, true);
                    return;
                }
                
                // 5. SUCESSO: Atualiza reservationData
                reservationData = { 
                    ...finalDataForDB, 
                    convidado_por: convidadoPorNome
                };
                
                showMessage("Reserva finalizada e salva com sucesso!");
                currentStep = 'success';
                render();

            } catch (error) {
                console.error("Erro Geral no Menu:", error);
                showMessage(`Erro Geral no Menu: ${error.message || 'Falha desconhecida.'}`, true);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Inicia o processo de inicializa√ß√£o quando a p√°gina √© carregada
        window.onload = initializeApp;
	
		
    </script>
</body>
</html>
